tinymce.PluginManager.requireLangPack('droplets','de');
tinymce.PluginManager.add('droplets', function(editor, url) {

    var droplets_list = new Array();
    var droplets      = new Object();
    var json = new tinymce.util.JSONRequest({
        url: url + '/droplets.php'
    });

    json.send({
        success: function(result) {
            for (var key in result) {
                if (result.hasOwnProperty(key)) {
                    droplets_list.push({text: "[["+result[key].title+"]]", value: result[key].title});
                    droplets[result[key].title] = result[key];
                }
            }
        }
    });

    function updateInfo(e) {
        var textCtrl1 = this.parent().parent().find('#droplet_description')[0];
        textCtrl1.value( droplets[e.control.value()].description );
        var textCtrl2 = this.parent().parent().find('#droplet_comment')[0];
        textCtrl2.value( droplets[e.control.value()].comment );
        var textCtrl3 = this.parent().parent().find('#droplet_insert')[0];
        textCtrl3.value( droplets[e.control.value()].usage );
    }

    editor.addButton('droplets', {
        tooltip: tinymce.util.I18n.translate('Insert Droplet'),
        image: url + '/img/droplets.png',
        onclick: function() {
            // Open window
            editor.windowManager.open({
                title : tinymce.util.I18n.translate('Insert Droplet'),
                width : 600,
                height: 300,
                onSubmit: function(e) {
                    //alert(e.data.droplet_insert);
                    editor.insertContent(e.data.droplet_insert);
                },
                body  : [
                    {
                        type: 'container',
        				layout: 'grid',
        				columns: 2,
                        spacingV: 5,
                        alignH: ['end','stretch'],
                        items: [
                            {
                                type: 'label',
                                text: 'Droplet'
                            },
                            {
                                name: 'droplet_select',
                				label: 'Droplet',
                				type: 'listbox',
                                values: droplets_list,
                                onselect: updateInfo,
                				autofocus: true
                            },
                            {
                                type: 'label',
                                text: tinymce.util.I18n.translate('Insert')
                            },
                            {
                                name: 'droplet_insert',
                                type: 'textbox',
                                value: droplets[droplets_list[0].value].usage
                            },
                            {
                                type: 'label',
                                text: tinymce.util.I18n.translate('Description')
                            },
                            {
                                name:  'droplet_description',
                                type:  'textbox',
                                value:  droplets[droplets_list[0].value].description,
                                disabled: true,
                                multiline: true,
                                style: 'min-height:50px;height:50px;max-height:50px;border:0;color:#000;'
                            },
                            {
                                type: 'label',
                                text: tinymce.util.I18n.translate('Comment')
                            },
                            {
                                name:  'droplet_comment',
                                type:  'textbox',
                                value:  droplets[droplets_list[0].value].comment,
                                disabled: true,
                                multiline: true,
                                style: 'height:100px;border:0;color:#000;'
                            }
                        ]
                    },
                ]
            });
        }
    });
});